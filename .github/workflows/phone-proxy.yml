name: Phone Server Proxy

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'  # Auto-restart every 30 minutes

jobs:
  proxy:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install fastapi uvicorn httpx
      
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          tags: tag:ci
          hostname: cantio-github-proxy
      
      - name: Create proxy server
        run: |
          cat > proxy.py << 'EOF'
          import httpx
          import logging
          from fastapi import FastAPI, Request, Response
          from fastapi.middleware.cors import CORSMiddleware
          
          logging.basicConfig(level=logging.INFO)
          logger = logging.getLogger(__name__)
          
          app = FastAPI()
          
          app.add_middleware(
              CORSMiddleware,
              allow_origins=["*"],
              allow_credentials=True,
              allow_methods=["*"],
              allow_headers=["*"],
          )
          
          PHONE_URL = "http://100.87.250.20:8081"
          
          @app.api_route("/{path:path}", methods=["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"])
          async def proxy(path: str, request: Request):
              target_url = f"{PHONE_URL}/{path}"
              if request.url.query:
                  target_url += f"?{request.url.query}"
              
              logger.info(f"Proxying {request.method} {target_url}")
              
              async with httpx.AsyncClient(timeout=30.0) as client:
                  try:
                      response = await client.request(
                          method=request.method,
                          url=target_url,
                          headers=dict(request.headers),
                          content=await request.body(),
                      )
                      return Response(
                          content=response.content,
                          status_code=response.status_code,
                          headers=dict(response.headers),
                      )
                  except Exception as e:
                      logger.error(f"Proxy error: {e}")
                      return Response(
                          content=f"Phone server unreachable: {str(e)}",
                          status_code=502,
                      )
          EOF
      
      - name: Start proxy server
        run: |
          uvicorn proxy:app --host 0.0.0.0 --port 8080 &
          PROXY_PID=$!
          echo "PROXY_PID=$PROXY_PID" >> $GITHUB_ENV
          sleep 5
          echo "‚úÖ Proxy server started (PID: $PROXY_PID)"
      
      - name: Enable Tailscale Funnel
        run: |
          echo "üåê Setting up Tailscale Serve and Funnel for public access..."
          
          # Set up serve to proxy HTTPS traffic to localhost:8080
          sudo tailscale serve https / http://localhost:8080
          sleep 2
          
          # Enable funnel for public internet access
          sudo tailscale funnel on
          sleep 3
          
          # Get the funnel URL
          FUNNEL_URL=$(tailscale status --json | jq -r '.Self.DNSName' | sed 's/\.$//')
          echo "üì° Public URL: https://$FUNNEL_URL"
          echo "üí° Health check: https://$FUNNEL_URL/kaithhealthcheck"
          echo ""
          echo "FUNNEL_URL=https://$FUNNEL_URL" >> $GITHUB_ENV
          
          # Show serve status
          sudo tailscale serve status
          
          echo "‚è∞ Proxy will run for 6 hours or until manually stopped"
      
      - name: Keep alive
        run: |
          trap 'echo "üõë Received cancellation signal"; kill $PROXY_PID 2>/dev/null; sudo tailscale funnel off; sudo tailscale serve reset; tailscale logout; exit 0' SIGTERM SIGINT
          
          while true; do
            if ! kill -0 $PROXY_PID 2>/dev/null; then
              echo "‚ùå Proxy process died unexpectedly"
              sudo tailscale funnel off
              sudo tailscale serve reset
              exit 1
            fi
            
            sleep 300
            echo "‚è±Ô∏è  Proxy still running... $(date)"
            echo "üåê Public URL: $FUNNEL_URL"
            curl -s http://localhost:8080/kaithhealthcheck > /dev/null || echo "‚ö†Ô∏è  Health check failed"
          done
